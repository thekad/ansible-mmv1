{{ template "python_file_header" . }}
from __future__ import absolute_import, division, print_function

__metaclass__ = type

################################################################################
# Documentation
################################################################################

ANSIBLE_METADATA = {
    "metadata_version": "1.1",
    "status": ["preview"],
    "supported_by": "community",
}

DOCUMENTATION = r"""
---
{{ $.Documentation.ToString }}"""

EXAMPLES = r"""
{{ $.Examples.ToString "doc" }}"""

RETURN = r"""
{{ $.Returns.ToString }}"""

################################################################################
# Imports
################################################################################

from ansible_collections.google.cloud.plugins.module_utils import gcp_utils as gcp
import types
# BEGIN Custom imports
{{ $.CustomCode.CustomImport }}
# END Custom imports

def build_link(module_params, uri):
    params = module_params.copy()
{{- range $.UrlParamOnlyProperties }}
    {{- if strEq .Type "ResourceRef" }}
    params["{{ .Name | underscore -}}"] = gcp.replace_resource_dict(module_params["{{ .Name | underscore -}}"], "{{ .Imports }}")
    {{- end }}
{{- end }}

    return ("{{ $.BaseUrl }}" + uri).format(
        **params
    )


{{ range $option := $.AllNestedOptions -}}
{{- if not $option.Virtual }}
class {{ $option.ClassName }}(gcp.Resource):
{{- if $option.InputSuboptions | len | gt 0 }}
    def _request(self):
        return {
    {{- range $suboption := $option.InputSuboptions }}
        {{- if not $suboption.Virtual }}
            "{{ $suboption.ApiName }}": {{""}}
        {{- if $suboption.IsNestedObject -}}
            {{- if $suboption.AllowEmptyObject -}}
            gcp.remove_nones({{ $suboption.ClassName }}(self.request.get("{{ $suboption.AnsibleName }}", {})).to_request()),  # allow empty values
            {{- else -}}
            gcp.remove_empties({{ $suboption.ClassName }}(self.request.get("{{ $suboption.AnsibleName }}", {})).to_request()),  # remove empty values
            {{- end -}}
        {{- else if $suboption.IsNestedList -}}
            [{{ $suboption.ClassName }}(item).to_request() for item in (self.request.get("{{ $suboption.AnsibleName }}") or [])],
        {{- else -}}
            self.request.get("{{ $suboption.AnsibleName }}"),
        {{- end }}
        {{- end }}
    {{- end }}
        }
{{- else if $option.SendEmptyValue }}
    def _request(self):
        return self.request.get("{{ $option.AnsibleName }}", {{ $option.Type }}())
{{- end }}

{{- if $option.OutputSuboptions | len | gt 0 }}
    def _response(self):
        return {
    {{- range $suboption := $option.OutputSuboptions }}
        {{- if not $suboption.Virtual }}
            "{{ $suboption.ApiName }}": {{""}}
        {{- if $suboption.IsNestedObject -}}
            {{ $suboption.ClassName }}().from_response(self.response.get("{{ $suboption.ApiName }}", {})),
        {{- else if $suboption.IsNestedList -}}
            [{{ $suboption.ClassName }}().from_response(item) for item in (self.response.get("{{ $suboption.ApiName }}") or [])],
        {{- else -}}
            self.response.get("{{ $suboption.ApiName }}"),
        {{- end }}
        {{- end }}
    {{- end }}
        }
{{- else if or $option.SendEmptyValue $option.AllowEmptyObject }}
    def _response(self):
        return self.response.get("{{ $option.AnsibleName }}", {{ $option.Type }}())
{{- end }}

{{- end }}
{{ end -}}
class {{ $.ModuleClass }}(gcp.Resource):
    def _request(self):
        return {
        {{- range $option := $.InputOptions }}
            {{- if not $option.Virtual }}
            "{{ $option.ApiName }}": {{ "" }}
            {{- if $option.IsNestedObject -}}
            {{- if $option.AllowEmptyObject -}}
            gcp.remove_nones({{ $option.ClassName }}(self.request.get("{{ $option.AnsibleName }}", {})).to_request()),  # allow empty values
            {{- else -}}
            gcp.remove_empties({{ $option.ClassName }}(self.request.get("{{ $option.AnsibleName }}", {})).to_request()),  # remove empty values
            {{- end -}}
            {{- else if $option.IsNestedList -}}
            [{{ $option.ClassName }}(item).to_request() for item in (self.request.get("{{ $option.AnsibleName }}") or [])],
            {{- else if $option.IsList -}}
            [{{ $option.Elements }}(item) for item in (self.request.get("{{ $option.AnsibleName }}") or [])],
            {{- else -}}
            self.request.get("{{ $option.AnsibleName }}"),
            {{- end -}}
            {{- end }}
        {{- end }}
        }

    def _response(self):
        return {
        {{- range $option := $.OutputOptions }}
            {{- if not $option.Virtual }}
            "{{ $option.ApiName }}": {{ if $option.IsNestedObject -}}
            {{ $option.ClassName }}().from_response(self.response.get("{{ $option.ApiName }}", {})),
            {{- else if $option.IsNestedList -}}
            [{{ $option.ClassName }}().from_response(item) for item in (self.response.get("{{ $option.ApiName }}") or [])],
            {{- else if $option.IsList -}}
            [{{ $option.Elements }}(item) for item in (self.response.get("{{ $option.ApiName }}") or [])],
            {{- else -}}
            self.response.get("{{ $option.ApiName }}"),
            {{- end }}
            {{- end }}
        {{- end }}
        }

################################################################################
# Main
################################################################################


def encode(self, obj):
    """
    This is a function bound to the main resource object. Its input is the object returned from to_request()
    and it mutates it before it is sent to the API.
    """

    {{- if and $.CustomCode.Encoder (not (strEq $.CustomCode.Encoder "_drop")) }}
    # --------- BEGIN custom encoder code ---------
    {{ $.CustomCode.Encoder | indent 4 false }}
    # --------- END custom encoder code ---------
    {{- else }}
    return obj
    {{- end }}


def decode(self, obj):
    """
    This is a function bound to the main resource object. Its input is the object returned from from_response()
    and it mutates it before it is returned to the module caller.
    """

    {{- if and $.CustomCode.Decoder (not (strEq $.CustomCode.Decoder "_drop")) }}
    # --------- BEGIN custom decoder code ---------
    {{ $.CustomCode.Decoder | indent 4 false }}
    # --------- END custom decoder code ---------
    {{- else }}
    return obj
    {{- end }}


def main():
    """Main function"""

    module = gcp.Module(
        {{ $.ArgumentSpec.ToString | indent 8 false }}
    )

    if not module.params["scopes"]:
        module.params["scopes"] = {{ $.Scopes | toJson }}

    state = module.params["state"]
    changed = False

    op_configs = gcp.ResourceOpConfigs({
    {{- range $op, $config := $.OperationConfigs }}
        "{{ $op }}": gcp.ResourceOpConfig(**{{ $config | toJson }}),
    {{- end }}
    })

    params = gcp.remove_nones(module.params)
    resource = {{ $.ModuleClass }}(params, module=module, product="{{ $.ProductName }}", kind="{{ $.Kind }}")
    read_uri = op_configs.read.uri

    resource._state = state  # store the state in the resource object
    # Bind the encode and decode functions to the resource object
    resource.encode_func = types.MethodType(encode, resource)
    resource.decode_func = types.MethodType(decode, resource)

    custom_diff = None  # Set this variable if you want to implement custom diff logic

    {{ if $.CustomCode.PreRead -}}
    # --------- BEGIN pre-read custom code ---------
    {{ $.CustomCode.PreRead | indent 4 false }}
    # --------- END pre-read custom code ---------
    {{- end }}

    read_url = build_link(params, read_uri)
    existing_obj = resource.get(read_url, allow_not_found=True)
    new_obj = {}
    gcp.debug(module, existing=existing_obj, post=False)

    {{ if $.CustomCode.PostRead -}}
    # --------- BEGIN post-read custom code ---------
    {{ $.CustomCode.PostRead | indent 4 false }}
    # --------- END post-read custom code ---------
    {{- end }}

    if custom_diff is not None:
        is_different = custom_diff
    else:
        is_different = resource.diff(gcp.remove_empties(existing_obj))
    gcp.debug(module, existing=existing_obj, post=True, is_different=is_different)

    if gcp.empty(existing_obj):
        if state == "present":
            create_uri = op_configs.create.uri
            create_async_uri = op_configs.create.async_uri
            try:
            {{- if and $.CustomCode.CustomCreate (not (strEq $.CustomCode.CustomCreate "_drop")) }}
                # --------- BEGIN custom create code ---------
                {{ $.CustomCode.CustomCreate | indent 16 false }}
                # --------- END custom create code ---------
            {{- else }}
                # --------- BEGIN create code ---------
                {{- if and $.CustomCode.PreCreate (not (strEq $.CustomCode.PreCreate "_drop")) }}
                # --------- BEGIN pre-create custom code ---------
                {{ $.CustomCode.PreCreate | indent 16 false }}
                # --------- END pre-create custom code ---------
                {{- end }}
                is_async = create_async_uri != ""
                create_link = build_link(params, create_uri)
                create_retries = op_configs.create.timeout
                create_func = getattr(resource, op_configs.create.verb)
                async_create_func = getattr(resource, op_configs.create.verb + "_async")
                async_create_link = build_link(params, "") + create_async_uri
                gcp.debug(module, msg="Creating resource", create_link=create_link, async_create_link=async_create_link, is_async=is_async)

                if is_async:
                    new_obj = async_create_func(
                        create_link,
                        async_link=async_create_link,
                        retries=create_retries
                    )
                else:
                    new_obj = create_func(create_link)
                {{- if and $.CustomCode.PostCreate (not (strEq $.CustomCode.PostCreate "_drop")) }}
                # --------- BEGIN post-create custom code ---------
                {{ $.CustomCode.PostCreate | indent 16 false }}
                # --------- END post-create custom code ---------
                {{- end }}
                # --------- END create code ---------
            {{- end }}
            except Exception as e:
                {{- if and $.CustomCode.PostCreateFailure (not (strEq $.CustomCode.PostCreateFailure "_drop")) }}
                # --------- BEGIN post-create custom failure code ---------
                {{ $.CustomCode.PostCreateFailure | indent 16 false }}
                # --------- END post-create custom failure code ---------
                {{- end }}
                module.fail_json(msg=str(e))

            changed = True
        else:
            pass  # nothing to do
    else:
        if state == "absent":
            delete_uri = op_configs.delete.uri
            delete_async_uri = op_configs.delete.async_uri
            try:
            {{- if and $.CustomCode.CustomDelete (not (strEq $.CustomCode.CustomDelete "_drop")) }}
                # --------- BEGIN custom delete code ---------
                {{ $.CustomCode.CustomDelete | indent 16 false }}
                # --------- END custom delete code ---------
            {{- else }}
                # --------- BEGIN delete code ---------
                {{- if and $.CustomCode.PreDelete (not (strEq $.CustomCode.PreDelete "_drop")) }}
                # --------- BEGIN pre-delete custom code ---------
                {{ $.CustomCode.PreDelete | indent 16 false }}
                # --------- END pre-delete custom code ---------
                {{- end }}
                is_async = delete_async_uri != ""
                delete_link = build_link(params, delete_uri)
                delete_retries = op_configs.delete.timeout
                delete_func = getattr(resource, op_configs.delete.verb)
                async_delete_func = getattr(resource, op_configs.delete.verb + "_async")
                async_delete_link = build_link(params, "") + delete_async_uri
                gcp.debug(
                    module,
                    msg="Destroying resource",
                    delete_link=delete_link,
                    async_delete_link=async_delete_link, is_async=is_async
                )
                if is_async:
                    new_obj = async_delete_func(
                        delete_link,
                        async_link=async_delete_link,
                        retries=delete_retries
                    )
                else:
                    new_obj = delete_func(delete_link)
                {{- if and $.CustomCode.PostDelete (not (strEq $.CustomCode.PostDelete "_drop")) }}
                # --------- BEGIN post-delete custom code ---------
                {{ $.CustomCode.PostDelete | indent 16 false }}
                # --------- END post-delete custom code ---------
                {{- end }}
                # --------- END delete code ---------
            {{- end }}
            except Exception as e:
                module.fail_json(msg=str(e))

            changed = True
        else:
            if is_different:
                update_uri = op_configs.update.uri
                update_async_uri = op_configs.update.async_uri
                try:
                {{- if and $.CustomCode.CustomUpdate (not (strEq $.CustomCode.CustomUpdate "_drop")) }}
                    # --------- BEGIN custom update code ---------
                    {{ $.CustomCode.CustomUpdate | indent 20 false }}
                    # --------- END custom update code ---------
                {{- else }}
                    # --------- BEGIN update code ---------
                    {{- if and $.CustomCode.PreUpdate (not (strEq $.CustomCode.PreUpdate "_drop")) }}
                    # --------- BEGIN pre-update custom code ---------
                    {{ $.CustomCode.PreUpdate | indent 20 false }}
                    # --------- END pre-update custom code ---------
                    {{- end }}
                    is_async = update_async_uri != ""
                    update_link = build_link(params, update_uri)
                    update_retries = op_configs.update.timeout
                    update_func = getattr(resource, op_configs.update.verb)
                    async_update_func = getattr(resource, op_configs.update.verb + "_async")
                    async_update_link = build_link(params, "") + update_async_uri
                    gcp.debug(module, msg="Updating resource", update_link=update_link, async_update_link=async_update_link, is_async=is_async)
                    if is_async:
                        new_obj = async_update_func(
                            update_link,
                            async_link=async_update_link,
                            retries=update_retries
                        )
                    else:
                        new_obj = update_func(update_link)
                    {{- if and $.CustomCode.PostUpdate (not (strEq $.CustomCode.PostUpdate "_drop")) }}
                    # --------- BEGIN post-update custom code ---------
                    {{ $.CustomCode.PostUpdate | indent 20 false }}
                    # --------- END post-update custom code ---------
                    {{ end -}}
                    # --------- END update code ---------
                {{- end }}
                except Exception as e:
                    module.fail_json(msg=str(e))

                changed = True

    new_obj.update({"changed": changed})
    gcp.debug(module, new=new_obj)
    module.exit_json(**new_obj)


if __name__ == "__main__":
    main()
