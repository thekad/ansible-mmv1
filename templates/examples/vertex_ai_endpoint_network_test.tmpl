- name: Test case
  block:
    - name: Create peering range
      google.cloud.gcp_compute_global_address:
        name: "{{`{{ resource_name }}`}}-peering"
        state: present
        address_type: INTERNAL
        prefix_length: 16
        purpose: VPC_PEERING
        network: "{{`{{ _network }}`}}"
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"

    - name: Connect peering range
      ansible.builtin.command: >
        gcloud services vpc-peerings connect
        --quiet
        --service=servicenetworking.googleapis.com
        --ranges="{{`{{ resource_name }}`}}-peering"
        --network="{{`{{ _network.name }}`}}"
        --project="{{`{{ gcp_project }}`}}"

    - name: Create Endpoint
      google.cloud.gcp_vertexai_endpoint:
        name: "{{`{{ resource_name }}`}}"
        state: present
        display_name: "{{`{{ resource_name }}`}}"
        network: "{{`projects/{{ gcp_project_number }}/global/networks/{{ _network.name }}`}}"
        region: us-central1
        location: us-central1
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"
      register: _myep

    - name: Run assertions
      ansible.builtin.assert:
        that:
          - _myep.changed == true

  always:
    - name: Delete Endpoint
      google.cloud.gcp_vertexai_endpoint:
        name: "{{`{{ resource_name }}`}}"
        state: absent
        display_name: "{{`{{ resource_name }}`}}"
        network: "{{`projects/{{ gcp_project_number }}/global/networks/{{ _network.name }}`}}"
        location: us-central1
        region: us-central1
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"

    - name: Delete peering range
      google.cloud.gcp_compute_global_address:
        name: "{{`{{ resource_name }}`}}-peering"
        state: absent
        address_type: INTERNAL
        prefix_length: 16
        purpose: VPC_PEERING
        network: "{{`{{ _network }}`}}"
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"
