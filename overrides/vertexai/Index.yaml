custom_code:
  custom_update: _drop
  pre_read: |
    # for this module, we're hitting the list endpoint and filtering on display name
    read_uri = f"{op_configs.base_url.uri}?filter=displayName={params.get("display_name")}"
  post_read: |
    # if there are existing indexes, the call would have returned a list
    if not gcp.empty(existing_obj):
        for idx in existing_obj.get("indexes", []):
            if idx.get("displayName") == params.get("display_name"):
                existing_obj = idx
                break
  pre_update: |
    # need to set to the required parameter "name" to the existing resource name
    params["name"] = existing_obj["name"].split("/")[-1]

    update_mask = []
    metadata_mask = []
    req_metadata = gcp.remove_empties(resource.to_request().get("metadata"))
    obj_metadata = gcp.remove_empties(existing_obj.get("metadata"))
    gcp.debug(module, req_metadata=req_metadata, obj_metadata=obj_metadata)
    if req_metadata.get("contentsDeltaUri") != obj_metadata.get("contentsDeltaUri"):
        metadata_mask.append("metadata.contentsDeltaUri")
    if req_metadata.get("isCompleteOverwrite", False) != obj_metadata.get("isCompleteOverwrite", False):
        metadata_mask.append("metadata.isCompleteOverwrite")
    if not gcp.deep_equal(req_metadata["config"], obj_metadata["config"]):
        metadata_mask.append("metadata.config")

    # if description is set, we need to update it
    if "description" in params:
        update_mask.append("description")

    if "labels" in params:
        update_mask.append("labels")

    # if we're updating metadata, we can't update other fields
    if len(metadata_mask) > 0 and len(update_mask) > 0:
        module.fail_json(msg="Cannot update index metadata and other fields at the same time")

    update_mask.extend(metadata_mask)
    update_uri += "?updateMask=" + ",".join(update_mask)

  pre_delete: |
    # need to set to the required parameter "name" to the existing resource name
    params["name"] = existing_obj["name"].split("/")[-1]
examples:
  - name: vertex_ai_index
    exclude_test: true
  - name: vertex_ai_index_streaming
    exclude_test: true
  - name: vertex_ai_index_test
    exclude_docs: true
